<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Fragment Market 27.0 (Working Media Demo)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --bg-color: #0e0e0e; --card-bg: #1c1c1e; --text-color: #ffffff;
            --accent-color: #007aff; --green-color: #34c759; --red-color: #ff3b30;
            --secondary-text: #8e8e93; --border-radius: 12px;
        }

        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        .container { padding: 16px; }
        .btn { background-color: var(--accent-color); color: white; border: none; padding: 14px 20px; border-radius: var(--border-radius); font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: opacity 0.2s; text-align: center; }
        .btn-green { background-color: var(--green-color); }
        .btn-outline { background: transparent; border: 1px solid #333; color: var(--text-color); }
        input, select { width: 100%; padding: 14px; background: var(--card-bg); border: 1px solid #333; border-radius: var(--border-radius); color: white; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; appearance: none; }
        /* –§–∏–ª—å—Ç—Ä—ã –≤ —Å–µ—Ç–∫–µ */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(10px); display: grid; grid-template-columns: repeat(4, 1fr); padding: 10px 0 20px 0; border-top: 1px solid #333; z-index: 100; }
        .nav-item { color: var(--secondary-text); text-align: center; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .market-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .nft-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 10px; text-align: center; position: relative; transition: transform 0.1s; }
        .nft-card:active { transform: scale(0.98); }
        .nft-img { width: 100%; aspect-ratio: 1; border-radius: 10px; margin-bottom: 8px; background-color: #2c2c2e; object-fit: cover; }
        .fav-icon { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.5); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; z-index: 10; }
        .section { display: none; animation: fadeIn 0.2s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .list-group { background: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; margin-bottom: 20px; }
        .list-item { padding: 16px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .balance-card { background: linear-gradient(135deg, #007aff, #005ecb); padding: 24px; border-radius: 16px; text-align: center; margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #151517; width: 90%; max-width: 400px; padding: 24px; border-radius: 16px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 16px; right: 16px; font-size: 24px; color: #888; cursor: pointer; }
        #priceChartPlaceholder { width: 100%; height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; margin: 15px 0; object-fit: cover; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .history-table th, .history-table td { padding: 8px 0; border-bottom: 1px solid #2c2c2e; text-align: left; }
        .history-table th { color: var(--secondary-text); }
        .history-table .change-up { color: var(--green-color); }
        .history-table .change-down { color: var(--red-color); }
        /* Metadata styling */
        .meta-table { width: 100%; margin-top: 15px; font-size: 14px; border-radius: var(--border-radius); overflow: hidden; background: #222; }
        .meta-table tr:nth-child(even) { background: #1c1c1e; }
        .meta-table td { padding: 10px 15px; }
        .meta-table .meta-label { color: var(--secondary-text); width: 35%; }
        .meta-table .meta-value { font-weight: 600; color: var(--text-color); }
        .meta-table .meta-rarity { color: var(--accent-color); font-size: 12px; float: right; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è Lottie-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        #nft-media-wrapper { display: flex; align-items: center; justify-content: center; overflow: hidden; height: 150px; background: #222; border-radius: 10px;}
        #nft-media-wrapper svg { width: 100%; height: 100%; }

        /* === –°–¢–ò–õ–ò –î–õ–Ø NFT –ë–ï–ó –ö–ê–†–¢–ò–ù–ö–ò (–°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê) === */
        .nft-card.no-image {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 180px;
            background-color: #121212;
        }
        .nft-card.no-image .nft-img {
            /* –°–∫—Ä—ã–≤–∞–µ–º img, –∫–æ–≥–¥–∞ –æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è */
            display: none; 
        }
        .nft-card.no-image div:nth-child(2) { 
             margin-bottom: 8px;
        }
        .nft-card.no-image .fav-icon {
            top: 18px;
        }
        .nft-card .image-placeholder-content {
            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥–ª—É—à–∫–∏ */
            display: none; 
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        /* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥–ª—É—à–∫—É, –∫–æ–≥–¥–∞ –∫–ª–∞—Å—Å no-image –∞–∫—Ç–∏–≤–µ–Ω */
        .nft-card.no-image .image-placeholder-content {
            display: flex; 
        }

    </style>
</head>
<body>

    <div id="market" class="section active container">
        <h2 id="market-title">üéÅ Mini Fragment Market</h2>
        <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ NFT..." onkeyup="filterNFTs()">
        
        <div class="filter-grid">
            <select id="rarity-filter" onchange="filterNFTs()">
                <option value="all">–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</option>
                </select>
            <select id="price-filter" onchange="filterNFTs()">
                <option value="all">–õ—é–±–∞—è —Ü–µ–Ω–∞</option>
                <option value="low">0‚ÇΩ - 7,000‚ÇΩ</option>
                <option value="mid">7,000‚ÇΩ - 15,000‚ÇΩ</option>
                <option value="high">15,000‚ÇΩ+</option>
            </select>
        </div>
        
        <div class="market-grid" id="market-list"></div>
    </div>

    <div id="favorites" class="section container">
        <h2>‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
        <div id="fav-list" class="market-grid">
            <div style="grid-column: span 2; text-align: center; color: #666; padding: 40px;">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö NFT</div>
        </div>
    </div>

    <div id="profile" class="section container">
        <h2>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
        <div class="balance-card">
            <div style="opacity: 0.8; font-size: 14px;">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance" id="user-balance" style="font-size: 32px; font-weight: bold; margin: 8px 0;">0.00 RUB</div>
            <div style="font-size: 12px;">ID: <span id="user-id">...</span> | Verif <span style="color:#fff;">‚úî</span></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-green" onclick="openModal('deposit-modal')">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn btn-outline" onclick="openModal('withdraw-modal')">–í—ã–≤–µ—Å—Ç–∏</button>
        </div>
        <div class="list-group">
            <div class="list-item"><span>–ù–∞ –≤—ã–≤–æ–¥–µ</span><span id="frozen-balance">0.00</span></div>
            <div class="list-item"><span>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</span><span>0</span></div>
        </div>
    </div>

    <div id="settings" class="section container">
        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="list-group">
            <div class="list-item">
                <span>–í–∞–ª—é—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                <select id="currency-select" onchange="changeCurrency()" style="width: auto; margin: 0; padding: 6px; height: auto;">
                    <option value="RUB">RUB (‚ÇΩ)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EURO (‚Ç¨)</option>
                    <option value="KZT">KZT (‚Ç∏)</option>
                    <option value="UAH">UAH (‚Ç¥)</option>
                </select>
            </div>
        </div>
        <div class="info-box" style="background: rgba(255, 165, 0, 0.15); color: #ffb340; padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 10px; line-height: 1.4;">
            –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ: <b>2%</b>.<br>
            –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7.
        </div>
        <br>
        <button class="btn btn-outline" onclick="window.open('https://t.me/SUPPORT_LINK', '_blank')">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('market', this)"><span class="nav-icon">üéÅ</span>Market</div>
        <div class="nav-item" onclick="switchTab('favorites', this)"><span class="nav-icon">‚ù§Ô∏è</span>Favs</div>
        <div class="nav-item" onclick="switchTab('profile', this)"><span class="nav-icon">üë§</span>Profile</div>
        <div class="nav-item" onclick="switchTab('settings', this)"><span class="nav-icon">‚öôÔ∏è</span>Set</div>
    </div>

    <div id="nft-modal" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('nft-modal')">&times;</div>
            
            <div id="nft-media-wrapper" class="nft-img" style="margin-top: 10px;">
                </div>
            
            <h2 id="m-title" style="margin: 10px 0 5px;">Title</h2>
            <h3 id="m-price" style="color: var(--green-color); margin: 0;">Price</h3>
            
            <table class="meta-table">
                <tr><td class="meta-label">–ö–æ–ª–ª–µ–∫—Ü–∏—è:</td><td class="meta-value" id="m-model"></td></tr>
                <tr><td class="meta-label">–°–∏–º–≤–æ–ª:</td><td class="meta-value" id="m-symbol"></td></tr>
                <tr><td class="meta-label">–†–∞—Ä–Ω–æ—Å—Ç—å/–§–æ–Ω:</td><td class="meta-value" id="m-backdrop"></td></tr>
            </table>

            <p style="font-size: 12px; color: #888; margin-top: 15px;">–î–∏–Ω–∞–º–∏–∫–∞ —Ü–µ–Ω—ã (5 –¥–Ω–µ–π):</p>
            
            <img id="priceChartPlaceholder" src="https://via.placeholder.com/400x150/111111/34c759?text=Price+Chart+Static" alt="–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã">

            <table class="history-table">
                <thead>
                    <tr><th>–î–∞—Ç–∞</th><th>–¶–µ–Ω–∞</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th></tr>
                </thead>
                <tbody id="price-history">
                    </tbody>
            </table>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-green">–ö—É–ø–∏—Ç—å</button>
                <button class="btn btn-outline" id="m-fav-btn" onclick="toggleFavFromModal()">‚òÜ</button>
            </div>
        </div>
    </div>

    <div id="deposit-modal" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('deposit-modal')">&times;</div>
            <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
            <label>–°–ø–æ—Å–æ–±:</label>
            <select id="deposit-method">
                <option>TON Coin</option>
                <option>USDT TRC20</option>
                <option>Visa/MasterCard RUB</option>
            </select>
            <label>–°—É–º–º–∞ (RUB):</label>
            <input type="number" placeholder="–û—Ç 1,000" id="deposit-amount">
            <button class="btn btn-green" onclick="startPayment('deposit')">–ù–∞—á–∞—Ç—å –æ–ø–ª–∞—Ç—É</button>
        </div>
    </div>

    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('withdraw-modal')">&times;</div>
            <h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
            <label>–°–ø–æ—Å–æ–±:</label>
            <select id="withdraw-method">
                <option>TON Coin (Wallet)</option>
                <option>USDT TRC20</option>
                <option>–ö–∞—Ä—Ç–∞ –†–§</option>
            </select>
            <label>–ê–¥—Ä–µ—Å/–†–µ–∫–≤–∏–∑–∏—Ç—ã:</label>
            <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –∏–ª–∏ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã" id="withdraw-address">
            <label>–°—É–º–º–∞ (RUB):</label>
            <input type="number" placeholder="–û—Ç 500" id="withdraw-amount">
            <button class="btn btn-red" onclick="startPayment('withdraw')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–≤–æ–¥</button>
        </div>
    </div>

    <div id="payment-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="close-btn" onclick="closeModal('payment-modal')">&times;</div>
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h3>
            <div id="payment-details" style="background: #222; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; font-size: 14px;">
                <p>–°—É–º–º–∞: <b id="p-amount">...</b></p>
                <p>–ú–µ—Ç–æ–¥: <b id="p-method">...</b></p>
                <p>–°—Ç–∞—Ç—É—Å: <b style="color: yellow;">–û–∂–∏–¥–∞–Ω–∏–µ...</b></p>
            </div>
            <p style="font-size: 12px; color: #888;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ –≤–∞—à–µ–º –∫–æ—à–µ–ª—å–∫–µ –∏–ª–∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</p>
            <button class="btn btn-outline" onclick="closeModal('payment-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // --- (1) –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function getPrice(amount) {
            const currency = document.getElementById('currency-select').value;
            const rates = { 'RUB': 1, 'USD': 0.0105, 'EUR': 0.0098, 'KZT': 4.8, 'UAH': 0.38 };
            const symbols = { 'RUB': '‚ÇΩ', 'USD': '$', 'EUR': '‚Ç¨', 'KZT': '‚Ç∏', 'UAH': '‚Ç¥' };
            const converted = (amount * rates[currency]).toFixed(2);
            return `${converted} ${symbols[currency]}`;
        }

        function changeCurrency() {
            renderMarket(collections, 'market-list');
            renderFavorites();
            document.getElementById('user-balance').innerText = getPrice(0); 
            document.getElementById('frozen-balance').innerText = getPrice(0);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generatePriceHistory(basePrice) {
            const history = [];
            let currentPrice = basePrice;
            const today = new Date();
            
            for (let i = 0; i < 5; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // Random change: -5% to +5%
                const changePercent = (Math.random() * 10 - 5).toFixed(1); 
                const changeAmount = Math.round(currentPrice * (changePercent / 100));
                
                const dayPrice = currentPrice - changeAmount;

                history.push({
                    date: date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' }),
                    price: dayPrice,
                    change: changeAmount
                });
                currentPrice = dayPrice;
            }
            return history.reverse(); 
        }

        // --- (2) –ö–û–õ–õ–ï–ö–¶–ò–Ø NFT (–¢–û–õ–¨–ö–û –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ö–û–õ–õ–ï–ö–¶–ò–ò TELEGRAM) ---
        
        const baseNfts = [
            { title: 'Artisan Brick', model: 'Artisan Bricks', symbol: 'ART-BRICK', priceBase: 12500, color: 'Brown/Earth' },
            { title: 'Astral Shard', model: 'Astral Shards', symbol: 'AST-SHARD', priceBase: 7800, color: 'Purple/Cosmic' },
            { title: 'B-Day Candle', model: 'B-Day Candles', symbol: 'BDAY-CANDLE', priceBase: 3500, color: 'Yellow/Flame' },
            { title: 'Durov\'s Cap', model: 'Durov\'s Caps', symbol: 'DUROV-CAP', priceBase: 25000, color: 'Blue/Legendary' },
            { title: 'Snoop Dogg', model: 'Snoop Doggs', symbol: 'SNOOP-DOGG', priceBase: 9900, color: 'Green/Smoke' },
            { title: 'Heroic Helmet', model: 'Heroic Helmets', symbol: 'HERO-HELM', priceBase: 18000, color: 'Red/Epic' },
            { title: 'Jester Hat', model: 'Jester Hats', symbol: 'JEST-HAT', priceBase: 6500, color: 'Pink/Fun' },
            { title: 'Moon Pendant', model: 'Moon Pendants', symbol: 'MOON-PEND', priceBase: 5200, color: 'Gray/Night' },
            { title: 'Pretty Posy', model: 'Pretty Posies', symbol: 'PRETTY-POS', priceBase: 15000, color: 'Orange/Floral' },
            { title: 'Skull Flower', model: 'Skull Flowers', symbol: 'SKULL-FLOW', priceBase: 4800, color: 'Black/Dark' },
            { title: 'Swiss Watch', model: 'Swiss Watches', symbol: 'SWISS-W', priceBase: 11000, color: 'Silver/Lux' },
            { title: 'Voodoo Doll', model: 'Voodoo Dolls', symbol: 'VOO-DOLL', priceBase: 7100, color: 'DarkGreen/Magic' },
        ];

        const collections = [];
        let nftCounter = 200000000; 

        for (let i = 0; i < 360; i++) { 
            const base = baseNfts[i % baseNfts.length];
            const uniqueId = nftCounter++;
            
            const price = Math.round(base.priceBase * (1 + (Math.random() - 0.5) * 0.6)); 
            const idString = uniqueId.toString().padStart(9, '0'); 
            
            // --- –ò–ú–ò–¢–ê–¶–ò–û–ù–ù–´–ï –ü–£–¢–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ ---
            let imgPath = `https://fragment.com/storage/media/gif_webp/${idString}_v1.webp`;
            let lottiePath = `https://fragment.com/storage/media/lottie/${idString}_v1.json`;
            
            // --- –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï: –î–õ–Ø –ü–ï–†–í–´–• 2-–• NFT –ò–°–ü–û–õ–¨–ó–£–ï–ú –†–ê–ë–û–ß–ò–ï CDN –°–°–´–õ–ö–ò –î–õ–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò ---
            if (i === 0) {
                // Working Lottie Demo 1 (TON-like style)
                lottiePath = 'https://assets5.lottiefiles.com/packages/lf20_tijmp3g6.json'; 
                // Placeholder WebP that is guaranteed to load
                imgPath = 'https://via.placeholder.com/150/007aff/FFFFFF?text=LOTTIE+PREVIEW+1';
            } else if (i === 1) {
                // Working Lottie Demo 2 (Simple Animation)
                lottiePath = 'https://assets8.lottiefiles.com/packages/lf20_n82i0jqs.json';
                // Placeholder WebP that is guaranteed to load
                imgPath = 'https://via.placeholder.com/150/34c759/FFFFFF?text=LOTTIE+PREVIEW+2';
            }
            // --------------------------------------------------------------------------------------------------

            collections.push({
                id: uniqueId,
                title: `${base.title} #${uniqueId.toString().slice(-4)}`, 
                model: base.model,
                symbol: base.symbol,
                backdrop: base.color,
                price: price,
                img: imgPath,
                lottie: lottiePath,
                isFav: false,
                history: generatePriceHistory(price)
            });
        }
        
        // --- (3) –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–†–ï–ó–ö–ò NFT –ù–ê –≠–ö–†–ê–ù (–° –û–ë–ù–û–í–õ–ï–ù–ù–´–ú FALLBACK) ---
        function createNftCard(nft) {
            const card = document.createElement('div');
            card.className = 'nft-card';
            card.setAttribute('data-id', nft.id);
            card.setAttribute('onclick', `openNftModal(${nft.id})`);

            const isFavClass = nft.isFav ? 'active' : '';

            card.innerHTML = `
                <div class="fav-icon ${isFavClass}" onclick="event.stopPropagation(); toggleFavorite(${nft.id});">
                    ${nft.isFav ? '‚òÖ' : '‚òÜ'}
                </div>
                <img class="nft-img" data-src="${nft.img}" alt="${nft.title}">
                
                <div class="image-placeholder-content">
                    <span style="font-size: 30px;">üíé</span>
                    <div style="margin-top: 5px; font-size: 10px; color: #555;">${nft.model.toUpperCase()}</div>
                    <div style="font-size: 9px; color: #444;">404 Lottie/WebP</div>
                </div>
                
                <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${nft.title}</div>
                <div style="font-size: 12px; color: var(--secondary-text); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${nft.model}</div>
                <div style="font-weight: bold; color: var(--green-color); font-size: 14px;">${getPrice(nft.price)}</div>
            `;

            // --- –õ–û–ì–ò–ö–ê –°–¢–ê–ë–ò–õ–¨–ù–û–ì–û FALLBACK ---
            const imgElement = card.querySelector('.nft-img');
            imgElement.onerror = function() {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –∑–∞–≥–ª—É—à–∫—É –≤ CSS
                card.classList.add('no-image');
                // –û—á–∏—â–∞–µ–º data-src, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
                imgElement.removeAttribute('data-src'); 
            };

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ src, —á—Ç–æ–±—ã —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É
            if (imgElement.dataset.src) {
                imgElement.src = imgElement.dataset.src;
            }
            // ------------------------------------

            return card;
        }


        // --- (4) –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–û–ú ---

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (–∏–º–∏—Ç–∞—Ü–∏—è)
        let favorites = new Set(JSON.parse(localStorage.getItem('nft_favorites') || '[]'));
        function saveFavorites() {
            localStorage.setItem('nft_favorites', JSON.stringify(Array.from(favorites)));
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ NFT
        function renderMarket(nfts, targetId) {
            const list = document.getElementById(targetId);
            list.innerHTML = '';
            if (nfts.length === 0) {
                 list.innerHTML = `<div style="grid-column: span 2; text-align: center; color: #666; padding: 40px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</div>`;
                 return;
            }

            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º
            if (targetId === 'market-list') {
                const models = [...new Set(collections.map(nft => nft.model))].sort();
                const filter = document.getElementById('rarity-filter');
                filter.innerHTML = '<option value="all">–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</option>';
                models.forEach(model => {
                    filter.innerHTML += `<option value="${model}">${model}</option>`;
                });
            }

            nfts.forEach(nft => {
                list.appendChild(createNftCard(nft));
            });
        }
        
        function renderFavorites() {
            const favNfts = collections.filter(nft => favorites.has(nft.id));
            renderMarket(favNfts, 'fav-list');
        }

        function toggleFavorite(id) {
            const nft = collections.find(n => n.id === id);
            if (!nft) return;

            nft.isFav = !nft.isFav;
            
            if (nft.isFav) {
                favorites.add(id);
            } else {
                favorites.delete(id);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            const card = document.querySelector(`.nft-card[data-id="${id}"]`);
            if (card) {
                const favIcon = card.querySelector('.fav-icon');
                if (favIcon) {
                    favIcon.innerHTML = nft.isFav ? '‚òÖ' : '‚òÜ';
                    favIcon.classList.toggle('active', nft.isFav);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ
            const modalFavBtn = document.getElementById('m-fav-btn');
            if (modalFavBtn && modalFavBtn.getAttribute('data-id') == id) {
                 modalFavBtn.innerHTML = nft.isFav ? '‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '‚òÜ –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            }

            saveFavorites();
            renderFavorites(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        }
        
        function toggleFavFromModal() {
            const modalFavBtn = document.getElementById('m-fav-btn');
            const id = parseInt(modalFavBtn.getAttribute('data-id'));
            toggleFavorite(id);
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        function filterNFTs() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const rarityFilter = document.getElementById('rarity-filter').value;
            const priceFilter = document.getElementById('price-filter').value;

            const filtered = collections.filter(nft => {
                // Search term filter (Title or Model)
                const searchMatch = nft.title.toLowerCase().includes(searchTerm) || 
                                    nft.model.toLowerCase().includes(searchTerm);

                // Rarity/Model filter
                const rarityMatch = rarityFilter === 'all' || nft.model === rarityFilter;

                // Price filter
                let priceMatch = true;
                if (priceFilter === 'low') {
                    priceMatch = nft.price >= 0 && nft.price <= 7000;
                } else if (priceFilter === 'mid') {
                    priceMatch = nft.price > 7000 && nft.price <= 15000;
                } else if (priceFilter === 'high') {
                    priceMatch = nft.price > 15000;
                }

                return searchMatch && rarityMatch && priceMatch;
            });

            renderMarket(filtered, 'market-list');
        }


        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        let currentLottieAnimation = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π Lottie-–∞–Ω–∏–º–∞—Ü–∏–∏

        function switchTab(tabId, element) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            element.classList.add('active');
            
            if (tabId === 'favorites') {
                renderFavorites();
            }

             // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Lottie –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (currentLottieAnimation) {
                currentLottieAnimation.destroy();
                currentLottieAnimation = null;
                document.getElementById('nft-media-wrapper').innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';

            // –û—á–∏—Å—Ç–∫–∞ Lottie –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ NFT
            if (modalId === 'nft-modal' && currentLottieAnimation) {
                currentLottieAnimation.destroy();
                currentLottieAnimation = null;
                document.getElementById('nft-media-wrapper').innerHTML = '';
            }
        }
        
        function openNftModal(id) {
            const nft = collections.find(n => n.id === id);
            if (!nft) return;

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            document.getElementById('m-title').innerText = nft.title;
            document.getElementById('m-price').innerText = getPrice(nft.price);
            document.getElementById('m-model').innerText = nft.model;
            document.getElementById('m-symbol').innerText = nft.symbol;
            document.getElementById('m-backdrop').innerText = nft.backdrop;

            // –ö–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
            const modalFavBtn = document.getElementById('m-fav-btn');
            modalFavBtn.setAttribute('data-id', id);
            modalFavBtn.innerHTML = nft.isFav ? '‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '‚òÜ –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';

            // –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω—ã
            const historyBody = document.getElementById('price-history');
            historyBody.innerHTML = '';
            nft.history.forEach(item => {
                const trend = item.change >= 0 ? 'change-up' : 'change-down';
                const sign = item.change >= 0 ? '‚ñ≤' : '‚ñº';
                historyBody.innerHTML += `
                    <tr>
                        <td>${item.date}</td>
                        <td>${getPrice(item.price)}</td>
                        <td class="${trend}">${sign} ${getPrice(Math.abs(item.change))}</td>
                    </tr>
                `;
            });
            
            // --- –ó–ê–ì–†–£–ó–ö–ê LOTTIE (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å) ---
            const mediaWrapper = document.getElementById('nft-media-wrapper');
            mediaWrapper.innerHTML = ''; // –û—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π Lottie/WebP

            if (currentLottieAnimation) {
                currentLottieAnimation.destroy();
                currentLottieAnimation = null;
            }

            if (nft.lottie) {
                // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å Lottie-—Ñ–∞–π–ª
                currentLottieAnimation = lottie.loadAnimation({
                    container: mediaWrapper,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: nft.lottie, // –ü—É—Ç—å –∫ Lottie-—Ñ–∞–π–ª—É
                    rendererSettings: {
                        preserveAspectRatio: 'xMidYMid slice'
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏: –µ—Å–ª–∏ Lottie –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è (404/–æ—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö), –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ WebP
                currentLottieAnimation.addEventListener('data_failed', () => {
                    console.warn('Lottie failed to load for NFT ID:', nft.id, 'Switching to WebP/Image fallback.');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–Ω—ã–π WebP/Fallback Image
                    mediaWrapper.innerHTML = `<img src="${nft.img}" alt="${nft.title}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;">`;
                    
                    // –ï—Å–ª–∏ –∏ WebP –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –∑–∞–≥–ª—É—à–∫—É
                    const fallbackImg = mediaWrapper.querySelector('img');
                    if(fallbackImg) {
                         fallbackImg.onerror = () => {
                             mediaWrapper.innerHTML = `<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; color: #888; font-size: 14px; background: #121212; border-radius: 10px;"><span style="font-size: 40px;">‚ùå</span><div style="margin-top: 5px;">MEDIA NOT FOUND</div></div>`;
                         };
                    } else {
                         mediaWrapper.innerHTML = `<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; color: #888; font-size: 14px; background: #121212; border-radius: 10px;"><span style="font-size: 40px;">‚ùå</span><div style="margin-top: 5px;">MEDIA NOT FOUND</div></div>`;
                    }
                });
            } else if (nft.img) {
                 // –ï—Å–ª–∏ –Ω–µ—Ç Lottie, –Ω–æ –µ—Å—Ç—å WebP/Image
                 mediaWrapper.innerHTML = `<img src="${nft.img}" alt="${nft.title}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 10px;">`;
            } else {
                 mediaWrapper.innerHTML = `<div style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; color: #888; font-size: 14px; background: #121212; border-radius: 10px;"><span style="font-size: 40px;">‚ùå</span><div style="margin-top: 5px;">MEDIA NOT FOUND</div></div>`;
            }
            // ------------------------------------

            openModal('nft-modal');
        }

        // –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –ø–ª–∞—Ç–µ–∂–∞
        function startPayment(type) {
            closeModal(`${type}-modal`);
            
            const amount = document.getElementById(`${type}-amount`).value || 'N/A';
            let method = '';
            
            if (type === 'deposit') {
                method = document.getElementById('deposit-method').value;
            } else {
                method = document.getElementById('withdraw-method').value;
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥
            }

            document.getElementById('p-amount').innerText = amount;
            document.getElementById('p-method').innerText = method;

            openModal('payment-modal');
        }

        // --- INIT (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò) ---
        function initializeApp() {
            try {
                // –ü–ï–†–ï–ú–ï–®–ò–í–ê–ï–ú, –Ω–æ –ø–µ—Ä–≤—ã–µ –¥–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –≤–∏–¥–Ω—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                const demoNfts = collections.splice(0, 2);
                shuffleArray(collections);
                collections.unshift(...demoNfts); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–±–æ—á–∏–µ NFT –≤ –Ω–∞—á–∞–ª–æ

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏ –≤–∞–ª—é—Ç—ã
                document.getElementById('user-balance').innerText = getPrice(0); 
                document.getElementById('frozen-balance').innerText = getPrice(0);

                // **–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ NFT –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ**
                renderMarket(collections, 'market-list');
                renderFavorites(); 

                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ Market –∞–∫—Ç–∏–≤–µ–Ω
                const marketTab = document.querySelector('.nav-item.active');
                if (marketTab) {
                    switchTab('market', marketTab);
                } else {
                     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Market –∞–∫—Ç–∏–≤–Ω—ã–º, –µ—Å–ª–∏ –Ω–∏—á—Ç–æ –Ω–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
                    switchTab('market', document.querySelector('.nav-item'));
                }

                console.log("App Initialized successfully. NFT count:", collections.length);
            } catch (error) {
                console.error("FATAL ERROR during initialization:", error);
                document.getElementById('market-list').innerHTML = `<div style="grid-column: span 2; color: #ff3b30; padding: 30px; text-align: center;">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</div>`;
            }
        }

        initializeApp();
    </script>
</body>
</html>
